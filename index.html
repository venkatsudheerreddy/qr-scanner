<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auto QR Decoder</title>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2>Upload QR Code</h2>
  <input type="file" accept="image/*" id="qrInput">

  <h3>Result:</h3>
  <div id="result"></div>

  <canvas id="canvas" hidden></canvas>

  <script>
        const SUPABASE_URL = "https://ngvoepsrgroxozyjvgyv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndm9lcHNyZ3JveG96eWp2Z3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDQ2NTMsImV4cCI6MjA3MjMyMDY1M30.x1zwFyAorfHU-VMYKS_8oVnOi95QUFeRzy0Xkc9zXSI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const fileInput = document.getElementById("qrInput");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const resultDiv = document.getElementById("result");

    fileInput.addEventListener("change", async () => {
      if (!fileInput.files.length) return;

      const file = fileInput.files[0];
      const img = new Image();
      img.src = URL.createObjectURL(file);

      img.onload = async () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0, img.width, img.height);
        const imageData = ctx.getImageData(0, 0, img.width, img.height);

        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
          const orderUUID = code.data.trim(); // QR contains order UUID
          resultDiv.innerHTML = `<p>QR Decoded: Order ID = ${orderUUID}</p>`;

          // Fetch order + menu details
          const { data: order, error } = await supabase
            .from("orders")
            .select("id, food_id, timestamp, menu:food_id(id, name, price, image)")
            .eq("id", orderUUID)
            .single();

          if (error) {
            resultDiv.innerHTML += `<p style="color:red;">Error: ${error.message}</p>`;
            return;
          }

          resultDiv.innerHTML += `
            <h4>Order Details</h4>
            <p>Order ID: ${order.id}</p>
            <p>Timestamp: ${order.timestamp}</p>
            <h4>Food Details</h4>
            <p>Name: ${order.menu.name}</p>
            <p>Price: ${order.menu.price}</p>
            <img src="${order.menu.image}" width="120">
          `;
        } else {
          resultDiv.innerHTML = "<p style='color:red;'>No QR code found.</p>";
        }
      };
    });
  </script>
</body>
</html>
