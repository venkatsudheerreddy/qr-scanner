<!DOCTYPE html>
<html>
<head>
  <title>QR Scanner + Upload</title>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; padding: 10px; background: #f5f5f5; }
    #reader { width: 100%; max-width: 400px; margin-bottom: 20px; }
    #resultCard {
      display: none;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      max-width: 400px;
    }
    #resultCard img { width: 100%; border-radius: 10px; margin-bottom: 10px; }
    #buttons { margin-top: 10px; }
    input[type="file"] { margin-bottom: 10px; }
    button { padding: 10px 15px; margin-top: 10px; border: none; border-radius: 5px; background: #2196F3; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Scan or Upload QR</h2>

  <!-- Camera scanner -->
  <div id="reader"></div>

  <hr>

  <!-- Upload QR image -->
  <label>Upload QR Image:</label>
  <input type="file" id="qrFile" accept="image/*">
  <div id="uploadResult"></div>

  <!-- Food Details Card -->
  <div id="resultCard">
    <img id="foodImage" src="" alt="Food Image">
    <h3 id="foodName"></h3>
    <p id="foodPrice"></p>
    <div id="buttons">
      <button id="backScanBtn">Back to Scan</button>
    </div>
  </div>

  <script>
    // Initialize Supabase
    const supabaseUrl = 'https://ngvoepsrgroxozyjvgyv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndm9lcHNyZ3JveG96eWp2Z3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDQ2NTMsImV4cCI6MjA3MjMyMDY1M30.x1zwFyAorfHU-VMYKS_8oVnOi95QUFeRzy0Xkc9zXSI';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const readerDiv = document.getElementById("reader");
    const resultCard = document.getElementById("resultCard");

    // Fetch food details from orderId
    async function fetchFood(orderId) {
      try {
        // Get the order
        const { data: order, error: orderError } = await supabase
          .from('orders')
          .select('foodId')
          .eq('id', orderId)
          .single();
        if (orderError || !order) {
          alert("Order not found!");
          return;
        }

        // Get the menu item
        const { data: food, error: foodError } = await supabase
          .from('menu')
          .select('*')
          .eq('id', order.foodId)
          .single();
        if (foodError || !food) {
          alert("Food not found!");
          return;
        }

        // Display food details
        document.getElementById("foodImage").src = food.image || "";
        document.getElementById("foodName").innerText = food.name;
        document.getElementById("foodPrice").innerText = "Price: â‚¹" + food.price;

        resultCard.style.display = "block";
        readerDiv.style.display = "none";
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    // Camera scanning
    async function onScanSuccess(decodedText) {
      await html5QrcodeScanner.clear();
      fetchFood(decodedText);
    }

    let html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);

    // Upload QR image
    const qrFileInput = document.getElementById("qrFile");
    qrFileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById("uploadResult").innerText = "Decoding image...";

      const html5QrCode = new Html5Qrcode("reader");

      html5QrCode.scanFileV2(file, true)
        .then(decodedResults => {
          // scanFileV2 returns array
          const decodedText = Array.isArray(decodedResults) ? decodedResults[0].decodedText : decodedResults.decodedText;
          document.getElementById("uploadResult").innerText = "QR Scanned: " + decodedText;
          fetchFood(decodedText);
        })
        .catch(err => {
          console.error(err);
          document.getElementById("uploadResult").innerText = "Failed to decode QR image.";
        });
    });

    // Back to scan button
    document.getElementById("backScanBtn").addEventListener("click", () => {
      resultCard.style.display = "none";
      readerDiv.style.display = "block";
      html5QrcodeScanner.render(onScanSuccess);
    });
  </script>
</body>
</html>
